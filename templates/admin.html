<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Emotion Music System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .stat-card h3 {
        font-size: 2.5rem;
        font-weight: bold;
      }
      .table-actions button {
        margin-right: 5px;
      }
      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <div class="admin-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="display-4">Admin Panel</h1>
            <p class="lead">Manage your Emotion Music System</p>
          </div>
          <div>
            <a href="/" class="btn btn-light me-2">Back to App</a>
            <button class="btn btn-outline-light" id="admin-logout-btn">
              Logout
            </button>
          </div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stat-card text-center">
            <i class="bi bi-people-fill fs-1"></i>
            <h3 id="stat-users">0</h3>
            <p>Total Users</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center">
            <i class="bi bi-music-note-list fs-1"></i>
            <h3 id="stat-songs">0</h3>
            <p>Total Songs</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center">
            <i class="bi bi-heart-fill fs-1"></i>
            <h3 id="stat-favorites">0</h3>
            <p>Total Favorites</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card text-center">
            <i class="bi bi-emoji-smile fs-1"></i>
            <h3 id="stat-emotions">0</h3>
            <p>Emotion Tags</p>
          </div>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="users-tab"
            data-bs-toggle="tab"
            data-bs-target="#users"
            type="button"
            role="tab"
          >
            Users Management
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="songs-tab"
            data-bs-toggle="tab"
            data-bs-target="#songs"
            type="button"
            role="tab"
          >
            Songs Management
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="upload-tab"
            data-bs-toggle="tab"
            data-bs-target="#upload"
            type="button"
            role="tab"
          >
            Upload Song
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="adminTabsContent">
        <!-- Users Management Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h3>User Management</h3>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Admin</th>
                      <th>Created At</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="users-table-body">
                    <tr>
                      <td colspan="6" class="text-center">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Songs Management Tab -->
        <div class="tab-pane fade" id="songs" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h3>Songs Management</h3>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Title</th>
                      <th>Artist</th>
                      <th>Emotion</th>
                      <th>Valence</th>
                      <th>Energy</th>
                      <th>Uploaded By</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="songs-table-body">
                    <tr>
                      <td colspan="8" class="text-center">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload Song Tab -->
        <div class="tab-pane fade" id="upload" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h3>Upload New Song</h3>
            </div>
            <div class="card-body">
              <form id="admin-upload-form">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="admin-song-title" class="form-label"
                      >Song Title *</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="admin-song-title"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="admin-song-artist" class="form-label"
                      >Artist Name *</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="admin-song-artist"
                      required
                    />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="admin-song-emotion" class="form-label"
                      >Emotion Tag *</label
                    >
                    <select
                      class="form-select"
                      id="admin-song-emotion"
                      required
                    >
                      <option value="">Select Emotion</option>
                      <option value="happy">Happy</option>
                      <option value="sad">Sad</option>
                      <option value="angry">Angry</option>
                      <option value="neutral">Neutral</option>
                      <option value="surprise">Surprise</option>
                      <option value="fear">Fear</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="admin-song-valence" class="form-label"
                      >Valence (0-1)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="admin-song-valence"
                      min="0"
                      max="1"
                      step="0.1"
                      value="0.5"
                    />
                    <small class="text-muted">Positivity level</small>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="admin-song-energy" class="form-label"
                      >Energy (0-1)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="admin-song-energy"
                      min="0"
                      max="1"
                      step="0.1"
                      value="0.5"
                    />
                    <small class="text-muted">Energy level</small>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="admin-audio-file" class="form-label"
                    >Audio File *</label
                  >
                  <input
                    type="file"
                    class="form-control"
                    id="admin-audio-file"
                    accept=".mp3,.wav,.ogg,.flac,.m4a"
                    required
                  />
                  <small class="text-muted"
                    >Supported formats: MP3, WAV, OGG, FLAC, M4A (Max
                    50MB)</small
                  >
                </div>
                <button type="submit" class="btn btn-primary btn-lg">
                  Upload Song
                </button>
              </form>
              <div id="admin-upload-status" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Load statistics
      function loadStats() {
        fetch("/admin/stats")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("stat-users").textContent =
                data.stats.total_users;
              document.getElementById("stat-songs").textContent =
                data.stats.total_songs;
              document.getElementById("stat-favorites").textContent =
                data.stats.total_favorites;
              document.getElementById("stat-emotions").textContent =
                data.stats.emotion_distribution.length;
            }
          })
          .catch((error) => console.error("Error loading stats:", error));
      }

      // Load users
      function loadUsers() {
        fetch("/admin/users")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const tbody = document.getElementById("users-table-body");
              tbody.innerHTML = "";

              data.users.forEach((user) => {
                const row = `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>
                                    <span class="badge ${
                                      user.is_admin
                                        ? "bg-success"
                                        : "bg-secondary"
                                    }">
                                        ${user.is_admin ? "Admin" : "User"}
                                    </span>
                                </td>
                                <td>${new Date(
                                  user.created_at
                                ).toLocaleDateString()}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-primary" onclick="toggleAdmin(${
                                      user.id
                                    }, ${user.is_admin})">
                                        ${
                                          user.is_admin
                                            ? "Remove Admin"
                                            : "Make Admin"
                                        }
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${
                                      user.id
                                    })">Delete</button>
                                </td>
                            </tr>
                        `;
                tbody.innerHTML += row;
              });
            }
          })
          .catch((error) => console.error("Error loading users:", error));
      }

      // Load songs
      function loadSongs() {
        fetch("/admin/songs")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const tbody = document.getElementById("songs-table-body");
              tbody.innerHTML = "";

              data.songs.forEach((song) => {
                const row = `
                            <tr>
                                <td>${song.id}</td>
                                <td>${song.title}</td>
                                <td>${song.artist}</td>
                                <td><span class="badge bg-info">${
                                  song.emotion_tag
                                }</span></td>
                                <td>${song.valence.toFixed(2)}</td>
                                <td>${song.energy.toFixed(2)}</td>
                                <td>${song.uploaded_by}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-danger" onclick="deleteSong(${
                                      song.id
                                    })">Delete</button>
                                </td>
                            </tr>
                        `;
                tbody.innerHTML += row;
              });
            }
          })
          .catch((error) => console.error("Error loading songs:", error));
      }

      // Toggle admin status
      function toggleAdmin(userId, isCurrentlyAdmin) {
        if (
          confirm(
            `Are you sure you want to ${
              isCurrentlyAdmin ? "remove admin rights from" : "make admin"
            } this user?`
          )
        ) {
          fetch(`/admin/update_user/${userId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ is_admin: !isCurrentlyAdmin }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert(data.message);
                loadUsers();
              } else {
                alert("Error: " + data.message);
              }
            });
        }
      }

      // Delete user
      function deleteUser(userId) {
        if (
          confirm(
            "Are you sure you want to delete this user? This action cannot be undone."
          )
        ) {
          fetch(`/admin/delete_user/${userId}`, { method: "DELETE" })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert(data.message);
                loadUsers();
                loadStats();
              } else {
                alert("Error: " + data.message);
              }
            });
        }
      }

      // Delete song
      function deleteSong(songId) {
        if (
          confirm(
            "Are you sure you want to delete this song? This action cannot be undone."
          )
        ) {
          fetch(`/admin/delete_song/${songId}`, { method: "DELETE" })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert(data.message);
                loadSongs();
                loadStats();
              } else {
                alert("Error: " + data.message);
              }
            });
        }
      }

      // Handle song upload
      document
        .getElementById("admin-upload-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData();
          formData.append(
            "title",
            document.getElementById("admin-song-title").value
          );
          formData.append(
            "artist",
            document.getElementById("admin-song-artist").value
          );
          formData.append(
            "emotion_tag",
            document.getElementById("admin-song-emotion").value
          );
          formData.append(
            "valence",
            document.getElementById("admin-song-valence").value
          );
          formData.append(
            "energy",
            document.getElementById("admin-song-energy").value
          );
          formData.append(
            "audio_file",
            document.getElementById("admin-audio-file").files[0]
          );

          const statusDiv = document.getElementById("admin-upload-status");
          statusDiv.innerHTML =
            '<div class="alert alert-info">Uploading...</div>';

          fetch("/upload_song", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                statusDiv.innerHTML =
                  '<div class="alert alert-success">' + data.message + "</div>";
                document.getElementById("admin-upload-form").reset();
                loadSongs();
                loadStats();
              } else {
                statusDiv.innerHTML =
                  '<div class="alert alert-danger">' + data.message + "</div>";
              }
            })
            .catch((error) => {
              statusDiv.innerHTML =
                '<div class="alert alert-danger">Error uploading song: ' +
                error +
                "</div>";
            });
        });

      // Logout
      document
        .getElementById("admin-logout-btn")
        .addEventListener("click", function () {
          fetch("/logout")
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                window.location.href = "/";
              }
            });
        });

      // Load data on page load
      loadStats();
      loadUsers();
      loadSongs();

      // Auto-refresh every 30 seconds
      setInterval(() => {
        loadStats();
      }, 30000);
    </script>
  </body>
</html>
